CREATE DATABASE calmaturnos;

CREATE TABLE Usuarios(
    id_usu int AUTO_INCREMENT PRIMARY KEY,
	nombre varchar(20) not null,
    apellido varchar(20) not null,
    n_usuario varchar(30) not null,
    email varchar(50) not null,
    contrasena varchar(30) not null
);

DELIMITER $$
CREATE PROCEDURE sp_CrearUsuario(
IN _nombre VARCHAR(20),
IN _apellido VARCHAR(20),
IN _usuario VARCHAR(30),
IN _email VARCHAR(50),
IN _contrasena VARCHAR(30))
BEGIN
	INSERT INTO usuarios(nombre, apellido, n_usuario, email, contrasena)
	VALUES(_nombre, _apellido, _usuario, _email, _contrasena);
END$$
DELIMITER ;

DELIMITER $$
CREATE PROCEDURE sp_BuscarUsuario(IN _usuario VARCHAR(30), IN _contrasena VARCHAR(30))
BEGIN
    SELECT n_usuario, contrasena
    FROM usuarios
    WHERE n_usuario = _usuario AND contrasena = _contrasena;
END$$
DELIMITER ;

use calmaturnos;

DELIMITER $$
CREATE PROCEDURE sp_AgregarTurno(IN _terapeuta varchar(20), IN _fecha DATE, IN _hora TIME, IN _usuario varchar(20))
BEGIN
	SELECT id_terapeuta, id_usuario
    FROM turnos
    WHERE Terapeutas.Nombre = _terapeuta AND Usuarios.n_usuario = _usuario;

    INSERT INTO Turnos(fecha, hora, id_terapeuta, id_usuario)
	VALUES(_fecha, _hora, id_terapeuta, id_usuario);
END$$
DELIMITER ; 

use calmaturnos;
DELIMITER $$
CREATE PROCEDURE SP_GuardarCodRecuperacion(IN _email VARCHAR(100), IN _codigo VARCHAR(10))
BEGIN
	UPDATE Usuarios
	SET codrecuperacion = _codigo
	WHERE email = _email;
END $$;

use calmaturnos;
DELIMITER $$
CREATE PROCEDURE SP_VerificarCodRecuperacion(IN _email VARCHAR(100), IN _codigo VARCHAR(10))

BEGIN
	SELECT id_Usu
	FROM Usuarios
	WHERE email = _email AND codrecuperacion = _codigo;
END $$;

use calmaturnos;
DELIMITER $$
CREATE PROCEDURE SP_VerificarEmail(IN _email VARCHAR(100))

BEGIN
	SELECT id_usu FROM Usuarios WHERE email = _email;
END$$;

